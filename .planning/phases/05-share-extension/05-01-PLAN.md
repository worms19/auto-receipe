---
phase: 05-share-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app.json
  - app/+native-intent.ts
  - app/(tabs)/index.tsx
  - lib/validation.ts
autonomous: false

must_haves:
  truths:
    - "WeChef appears in iOS share sheet when user shares an Instagram URL"
    - "Shared Instagram URL is validated before processing begins"
    - "App opens and automatically begins processing after receiving shared URL"
    - "Complete flow works: share from Instagram -> processing -> recipe saved"
    - "Repeated shares work when app is already running in background"
  artifacts:
    - path: "app/+native-intent.ts"
      provides: "Deep link routing for share extension"
      exports: ["redirectSystemPath"]
    - path: "lib/validation.ts"
      provides: "Instagram URL validation utility"
      exports: ["isInstagramUrl", "extractInstagramUrl"]
    - path: "app/(tabs)/index.tsx"
      provides: "Share intent handling integrated into home screen"
      contains: "useShareIntent"
    - path: "app.json"
      provides: "expo-share-intent plugin config with activation rules"
      contains: "expo-share-intent"
    - path: "package.json"
      provides: "expo-share-intent + patch-package dependencies and postinstall script"
      contains: "expo-share-intent"
  key_links:
    - from: "iOS Share Extension (native)"
      to: "app/+native-intent.ts"
      via: "wechef:// deep link with share extension key"
      pattern: "getShareExtensionKey"
    - from: "app/+native-intent.ts"
      to: "app/(tabs)/index.tsx"
      via: "redirect to / where useShareIntent hook picks up intent"
      pattern: "return \"/\""
    - from: "app/(tabs)/index.tsx"
      to: "lib/validation.ts"
      via: "isInstagramUrl check before calling handleProcess"
      pattern: "isInstagramUrl"
    - from: "app/(tabs)/index.tsx useShareIntent hook"
      to: "usePipelineStore().startProcessing(url)"
      via: "handleProcess function (already exists)"
      pattern: "handleProcess"
---

<objective>
Install expo-share-intent, configure the iOS Share Extension, create the share intent
routing and validation code, integrate into the home screen, rebuild the dev client,
and verify the complete share-to-recipe flow.

Purpose: This is the final phase of WeChef. After this, users can share an Instagram
reel URL directly from the iOS share sheet and have it automatically processed into a
structured recipe -- the core UX promise of the app.

Output: Working iOS Share Extension that receives Instagram URLs and triggers the
existing processing pipeline. Dev client rebuilt with native share extension target.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-share-extension/05-RESEARCH.md

@app.json
@package.json
@app/(tabs)/index.tsx
@app/_layout.tsx
@lib/pipeline/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, configure plugin, set up patch-package</name>
  <files>package.json, app.json, patches/expo-share-intent+*.patch</files>
  <action>
1. Install expo-share-intent and patch-package:
   ```
   npx expo install expo-share-intent
   npm install --save-dev patch-package
   ```

2. Add postinstall script to package.json:
   ```json
   "postinstall": "patch-package"
   ```
   Add this to the existing "scripts" object. Do NOT replace existing scripts.

3. Copy the required xcode patch from the expo-share-intent example project.
   The patch file lives in the expo-share-intent npm package. Find it:
   ```
   ls node_modules/expo-share-intent/patches/
   ```
   Copy whatever .patch files exist there into a top-level `patches/` directory in the project root.
   If the patches directory does not exist in the npm package, check the expo-share-intent
   GitHub repo example project for the patch file, or run `npx patch-package expo-share-intent`
   after manually applying any needed fix.

4. Run `npm run postinstall` (or `npx patch-package`) to verify the patch applies cleanly.

5. Update app.json plugins array. Add expo-share-intent AFTER the existing plugins:
   ```json
   "plugins": [
     "expo-sqlite",
     "expo-router",
     [
       "expo-share-intent",
       {
         "iosActivationRules": {
           "NSExtensionActivationSupportsWebURLWithMaxCount": 1,
           "NSExtensionActivationSupportsText": true
         }
       }
     ]
   ]
   ```
   IMPORTANT: Keep "expo-sqlite" and "expo-router" exactly as they are. Only add the
   expo-share-intent entry. The iosActivationRules must include BOTH WebURL and Text
   because Instagram sometimes shares URLs as plain text (see research pitfall #2).
  </action>
  <verify>
- `cat package.json | grep expo-share-intent` shows the dependency
- `cat package.json | grep postinstall` shows the script
- `ls patches/` shows at least one .patch file (or confirms patches applied)
- `cat app.json | grep expo-share-intent` shows the plugin entry
- `npm run postinstall` exits 0 (patch applies cleanly)
  </verify>
  <done>
expo-share-intent is installed, patch-package is configured with postinstall script,
the xcode patch is in place, and app.json has the plugin with correct iOS activation
rules for both URL and text content types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create validation utility, native intent file, and integrate share hook into home screen</name>
  <files>lib/validation.ts, app/+native-intent.ts, app/(tabs)/index.tsx</files>
  <action>
1. Create `lib/validation.ts` with Instagram URL validation:
   ```typescript
   const INSTAGRAM_URL_PATTERNS = [
     /^https?:\/\/(www\.)?(instagram\.com)\/(reel|p|tv)\/[\w-]+/i,
     /^https?:\/\/(www\.)?(instagr\.am)\/(reel|p|tv)\/[\w-]+/i,
   ];

   export function isInstagramUrl(url: string): boolean {
     return INSTAGRAM_URL_PATTERNS.some(pattern => pattern.test(url.trim()));
   }

   export function extractInstagramUrl(text: string): string | null {
     const urlMatch = text.match(
       /https?:\/\/(www\.)?(instagram\.com|instagr\.am)\/(reel|p|tv)\/[\w-]+[^\s]*/i
     );
     return urlMatch ? urlMatch[0] : null;
   }
   ```
   This is a simple client-side validation for UX feedback. The server also validates,
   so this is not a security boundary.

2. Create `app/+native-intent.ts` for expo-router deep link routing:
   ```typescript
   import { getShareExtensionKey } from "expo-share-intent";

   export async function redirectSystemPath({
     path,
     initial,
   }: {
     path: string;
     initial: boolean;
   }) {
     if (path.includes(`dataUrl=${getShareExtensionKey()}`)) {
       return "/";
     }
     return path;
   }
   ```
   This intercepts the share extension's deep link and redirects to the home screen
   where useShareIntent() will pick up the shared content.

3. Modify `app/(tabs)/index.tsx` to add share intent handling:
   - Add import: `import { useShareIntent } from "expo-share-intent";`
   - Add import: `import { isInstagramUrl, extractInstagramUrl } from "@/lib/validation";`
   - Add import: `import { useEffect } from "react";` (useEffect is NOT currently imported -- only useState and useCallback are)
   - Inside the RecipeList component, add the useShareIntent hook AFTER the existing
     usePipelineStore() call:
     ```typescript
     const { hasShareIntent, shareIntent, resetShareIntent } = useShareIntent({
       resetOnBackground: true,
     });
     ```
   - Add a useEffect that watches for incoming share intents:
     ```typescript
     useEffect(() => {
       if (hasShareIntent && shareIntent) {
         const url = shareIntent.webUrl || shareIntent.text;
         if (url) {
           const instagramUrl = extractInstagramUrl(url);
           if (instagramUrl && isInstagramUrl(instagramUrl)) {
             handleProcess(instagramUrl);
           }
         }
         resetShareIntent();
       }
     }, [hasShareIntent, shareIntent]);
     ```
   - IMPORTANT: Call resetShareIntent() AFTER processing regardless of validation
     result, to clear the intent and allow future shares.
   - IMPORTANT: Use extractInstagramUrl first (handles URL embedded in text), then
     validate with isInstagramUrl. This handles Instagram's varied sharing formats.
   - Do NOT modify handleProcess, handleModalClose, handleRecipeSaved, or any other
     existing function. The share intent hook simply calls the existing handleProcess.
  </action>
  <verify>
- `cat lib/validation.ts` shows isInstagramUrl and extractInstagramUrl exports
- `cat app/+native-intent.ts` shows redirectSystemPath with getShareExtensionKey check
- `grep -n "useShareIntent" app/\(tabs\)/index.tsx` shows the hook usage
- `grep -n "isInstagramUrl" app/\(tabs\)/index.tsx` shows validation usage
- TypeScript compiles: `npx tsc --noEmit` passes (or at least no errors in modified files)
  </verify>
  <done>
lib/validation.ts exists with isInstagramUrl and extractInstagramUrl functions.
app/+native-intent.ts exists and routes share deep links to home screen.
app/(tabs)/index.tsx uses useShareIntent hook to detect shared URLs, validates them
as Instagram URLs, and calls the existing handleProcess function to begin processing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete iOS Share Extension integration: expo-share-intent installed and configured,
native intent routing, Instagram URL validation, and share intent hook wired into
the home screen processing pipeline.

Before verifying, the dev client MUST be rebuilt since the share extension is a native
iOS target. Run these commands:
```
npx expo prebuild --clean
npx expo run:ios
```
This will take a few minutes as it rebuilds the native project with the new share
extension target.
  </what-built>
  <how-to-verify>
1. After rebuild completes and the app launches in the simulator/device:

2. **Test share extension appears:**
   - Open Safari on the iOS device/simulator
   - Navigate to any Instagram reel URL (e.g., https://www.instagram.com/reel/ABC123/)
   - Tap the Share button in Safari
   - Scroll through the share sheet -- "WeChef" should appear as an option
   - If WeChef does NOT appear: wait 30 seconds and try again (iOS caches share extension availability)

3. **Test share flow from Safari:**
   - Share an actual Instagram reel URL to WeChef from Safari
   - WeChef should open and the processing modal should appear automatically
   - If the NestJS server is running (`npm run servers`), processing should complete
     and a recipe should be saved

4. **Test repeated shares:**
   - With WeChef still open (in background), go back to Safari
   - Share another Instagram URL to WeChef
   - WeChef should come to foreground and start processing the new URL

5. **Test invalid URL rejection:**
   - Share a non-Instagram URL (e.g., https://google.com) to WeChef
   - The app should open but NOT start processing (no modal appears)

NOTE: Testing from the actual Instagram app requires a real device with Instagram
installed. The Safari test confirms the share extension works. Instagram-specific
testing is a nice-to-have.
  </how-to-verify>
  <resume-signal>Type "approved" if the share extension works, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
- WeChef appears in iOS share sheet when sharing a URL from Safari
- Sharing an Instagram URL opens WeChef and triggers processing automatically
- Sharing a non-Instagram URL opens WeChef but does not trigger processing
- The existing URL input still works (regression check)
- `npx tsc --noEmit` passes
- `cat app.json` shows expo-share-intent plugin with correct activation rules
</verification>

<success_criteria>
1. App appears in iOS share sheet for both URL and text content types
2. Shared Instagram URL (from Safari or Instagram) triggers automatic processing
3. Non-Instagram URLs are rejected with no processing started
4. Repeated shares work when app is already running in background
5. Complete flow verified: share URL -> app opens -> processing -> recipe saved
6. Existing manual URL input flow still works (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/05-share-extension/05-01-SUMMARY.md`
</output>
