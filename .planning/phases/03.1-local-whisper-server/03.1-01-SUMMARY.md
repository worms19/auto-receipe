---
phase: 03.1-local-whisper-server
plan: 01
subsystem: api
tags: [whisper, local-server, dev-mode, transcription, whisper-cpp]

# Dependency graph
requires:
  - phase: 03-01
    provides: "Whisper transcription service, API config, error types"
  - phase: 03-02
    provides: "Pipeline store with real API integration"
provides:
  - "Environment-aware Whisper endpoint (local in dev, OpenAI in prod)"
  - "isLocalWhisper flag for conditional API key retrieval"
  - "NSAllowsLocalNetworking for iOS dev client builds"
  - "whisper-server startup script with validation"
affects: [04-video-processing, 05-polish]

# Tech tracking
tech-stack:
  added: []
  patterns: ["__DEV__ conditional endpoint selection", "Optional API key for local services"]

key-files:
  created: ["scripts/whisper-server.sh"]
  modified: ["lib/api/whisper.ts", "lib/pipeline/store.ts", "app.json", ".env.example"]

key-decisions:
  - "Local whisper.cpp server instead of OpenAI Whisper API to eliminate dev fees"
  - "__DEV__ global for endpoint switching (React Native built-in, no extra config)"
  - "isLocalWhisper derived from endpoint URL prefix, not __DEV__ directly"

patterns-established:
  - "__DEV__ conditional: Use React Native's __DEV__ global for dev/prod branching"
  - "Optional API key: Make apiKey parameter optional when local service available"

# Metrics
duration: ~2min
completed: 2026-02-08
status: paused-at-checkpoint
---

# Phase 3.1 Plan 1: Local Whisper Server Summary

**Local whisper.cpp server replaces OpenAI Whisper API in dev mode via __DEV__ conditional endpoint**

## Performance

- **Duration:** ~2 min
- **Started:** 2026-02-08T12:47:27Z
- **Paused at checkpoint:** 2026-02-08T12:49:29Z
- **Tasks:** 2 of 3 complete (Task 3 is checkpoint:human-verify)
- **Files modified:** 5

## Accomplishments

- Made whisper.ts endpoint configurable: local server (127.0.0.1:8080) in dev, OpenAI in prod
- Exported isLocalWhisper flag for pipeline store to conditionally skip OpenAI key retrieval
- Made apiKey parameter optional; Authorization header only sent to OpenAI
- Added NSAllowsLocalNetworking to app.json for iOS dev client builds
- Created scripts/whisper-server.sh with binary/model/ffmpeg validation and configurable env vars
- Updated .env.example to document OpenAI key is optional with local whisper-server

## Task Commits

Each task was committed atomically:

1. **Task 1: Make whisper.ts endpoint configurable and update pipeline store** - `dd892db` (feat)
2. **Task 2: Add local networking permission, startup script, and update docs** - `8934724` (feat)
3. **Task 3: Verify local whisper transcription works end-to-end** - PENDING (checkpoint:human-verify)

## Files Created/Modified

- `lib/api/whisper.ts` - Environment-aware endpoint with __DEV__, optional apiKey, conditional auth header
- `lib/pipeline/store.ts` - Conditional getOpenAIKey() call using isLocalWhisper flag
- `app.json` - Added NSAllowsLocalNetworking under expo.ios.infoPlist
- `scripts/whisper-server.sh` - Convenience script to start whisper.cpp server with validation
- `.env.example` - Documented OpenAI key as optional in dev with local whisper-server

## Decisions Made

1. **__DEV__ for endpoint switching**: Used React Native's built-in `__DEV__` global rather than environment variables. This is idiomatic in React Native and requires zero configuration.

2. **isLocalWhisper derived from URL**: Derived `isLocalWhisper` from the endpoint URL (`startsWith('http://127.0.0.1')`) rather than directly from `__DEV__`. This makes the check semantically clear and decoupled.

3. **exec in startup script**: Used `exec` to replace the shell process with whisper-server for clean signal handling (Ctrl+C works directly).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

**whisper.cpp must be built from source.** See plan frontmatter `user_setup` for:
- Prerequisites: `brew install cmake ffmpeg`
- Clone and build whisper.cpp with server binary enabled
- Download the small.en model (488 MB)
- Verification: `~/whisper.cpp/build/bin/whisper-server --help`

## Next Steps

**Task 3 (checkpoint:human-verify):** User needs to verify local whisper transcription works end-to-end by starting the server and testing with curl.

---
*Phase: 03.1-local-whisper-server*
*Status: Paused at Task 3 checkpoint*
