<!-- SUPERSEDED: This plan described client-side pipeline integration with real extraction.
     It was implemented (commit b12e36d) then reverted (1140ef5) in favor of a server-side
     NestJS architecture (commits e996950, 4dba4f8). Kept for reference. -->

---
phase: 04-video-extraction
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - lib/pipeline/store.ts
autonomous: false

must_haves:
  truths:
    - "Pipeline downloads real video from Instagram URL via Cobalt"
    - "Pipeline extracts real audio from downloaded video"
    - "Pipeline captures thumbnail from video"
    - "Temporary video file is deleted after extraction (never persisted)"
    - "Audio file is cleaned up after transcription"
    - "Thumbnail is saved to recipe record"
    - "Extraction errors surface to user with descriptive messages"
  artifacts:
    - path: "lib/pipeline/store.ts"
      provides: "Pipeline with real extraction integration"
      contains: "extractFromInstagramUrl"
  key_links:
    - from: "lib/pipeline/store.ts"
      to: "lib/extraction/extract.ts"
      via: "extractFromInstagramUrl import"
      pattern: "import.*extractFromInstagramUrl.*from.*extraction/extract"
    - from: "lib/pipeline/store.ts"
      to: "lib/api/whisper.ts"
      via: "transcribeAudio with real audioUri"
      pattern: "transcribeAudio\\(.*audioUri"
    - from: "lib/pipeline/store.ts"
      to: "deleteAsync"
      via: "Audio file cleanup after transcription"
      pattern: "deleteAsync.*audioUri"
---

<objective>
Wire real extraction into the pipeline store, replacing mockDownload and mockExtract with the extraction services from Plan 01.

Purpose: Complete the end-to-end flow so that entering an Instagram URL actually downloads the video, extracts audio, captures a thumbnail, transcribes, and structures into a recipe. This is the moment the app goes from mocks to real functionality for the extraction stages.

Output: Updated `lib/pipeline/store.ts` with real extraction, proper cleanup, and end-to-end verification.
</objective>

<execution_context>
@/Users/damienanselmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damienanselmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-video-extraction/04-RESEARCH.md
@.planning/phases/04-video-extraction/04-01-SUMMARY.md
@lib/pipeline/store.ts
@lib/pipeline/mock-api.ts
@lib/extraction/extract.ts
@lib/extraction/types.ts
@lib/api/whisper.ts
@lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace mock download/extract with real extraction in pipeline store</name>
  <files>
    - lib/pipeline/store.ts
  </files>
  <action>
Modify `lib/pipeline/store.ts` to use real extraction services instead of mocks.

**1. Update imports -- remove mocks, add extraction:**

Remove:
```typescript
import { mockDownload, mockExtract } from './mock-api';
```

Add:
```typescript
import { extractFromInstagramUrl } from '@/lib/extraction/extract';
import { deleteAsync } from 'expo-file-system/legacy';
```

Keep existing imports for transcribeAudio, structureRecipe, getOpenAIKey, getAnthropicKey, isLocalWhisper.

**2. Rewrite the startProcessing function stages:**

The downloading and extracting stages are now combined into a single `extractFromInstagramUrl` call that handles both. Update the stage transitions to reflect this:

```typescript
startProcessing: async (url: string) => {
  set({ ...initialState, sourceUrl: url, stage: 'downloading' });

  try {
    // Stages 1+2: Download video + Extract audio/thumbnail
    // extractFromInstagramUrl handles: URL validation, Cobalt resolution,
    // video download, audio extraction, thumbnail capture, video cleanup
    const { audioUri, thumbnailUri } = await extractFromInstagramUrl(url);
    set({ stage: 'transcribing', progress: 0.5 });

    // Stage 3: Transcribe audio
    let transcript: string;
    if (isLocalWhisper) {
      transcript = await transcribeAudio(audioUri);
    } else {
      const openaiKey = await getOpenAIKey();
      transcript = await transcribeAudio(audioUri, openaiKey);
    }

    // Clean up audio file after successful transcription
    try {
      await deleteAsync(audioUri, { idempotent: true });
    } catch {
      // Best-effort cleanup
    }

    set({ stage: 'structuring', progress: 0.75 });

    // Stage 4: Structure recipe
    const anthropicKey = await getAnthropicKey();
    const recipe = await structureRecipe(transcript, anthropicKey);
    set({ stage: 'complete', progress: 1 });

    // Return recipe with source URL and thumbnail
    return { ...recipe, sourceUrl: url, thumbnailUrl: thumbnailUri };
  } catch (error) {
    const message =
      error instanceof Error ? error.message : 'Processing failed';
    set({ stage: 'error', error: message });
    return null;
  }
},
```

**Key changes from current code:**
- `mockDownload(url)` + `mockExtract()` replaced by single `extractFromInstagramUrl(url)` call
- No separate "extracting" stage set -- extraction is part of downloading (Cobalt resolve + download + extract happen together, and the UI already shows "Downloading video..." and "Extracting content..." labels)
- After extraction completes, set stage directly to 'transcribing' at 0.5 progress
- `audioUri` is now a real file URI from the native module (not the string 'extracted_audio')
- `thumbnailUri` is now a real persistent file URI
- Audio file cleanup happens after transcription completes (try/catch, best-effort)
- Video file cleanup is handled inside `extractFromInstagramUrl` via try/finally (Plan 01)
- Recipe now includes `thumbnailUrl: thumbnailUri` (was `null` before)

**3. Add extracting stage transition** for better UX feedback:

Actually, to better use the existing stage labels, set the extracting stage between download and transcription. Update to:

```typescript
// Stage 1: Download video from Instagram
set({ stage: 'downloading', progress: 0.1 });
const { audioUri, thumbnailUri } = await extractFromInstagramUrl(url);

// Note: extractFromInstagramUrl handles download + audio extraction + thumbnail
// in one call. We skip the 'extracting' stage visually since extraction is
// included in the download call. The progress jumps from downloading to transcribing.

set({ stage: 'transcribing', progress: 0.5 });
```

This is acceptable because the extraction happens fast relative to the download and transcription. The user sees "Downloading video..." during the entire extraction pipeline, then "Transcribing audio..." during whisper, then "Creating recipe..." during Claude.

**4. Do NOT delete mock-api.ts.** Leave it in the codebase as reference but it should no longer be imported by store.ts. A future cleanup can remove it.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `lib/pipeline/store.ts` does NOT import from `./mock-api`
- `lib/pipeline/store.ts` imports `extractFromInstagramUrl` from `@/lib/extraction/extract`
- `lib/pipeline/store.ts` imports `deleteAsync` from `expo-file-system/legacy`
- Recipe return includes `thumbnailUrl: thumbnailUri` (not null)
- `lib/pipeline/mock-api.ts` still exists (not deleted)
- No TypeScript errors
  </verify>
  <done>
Pipeline store uses real extraction. mockDownload and mockExtract are no longer called. Real audio URI passed to transcribeAudio, real thumbnail URI saved to recipe, video file cleaned up by extraction orchestrator, audio file cleaned up after transcription.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end extraction verification</name>
  <what-built>
Complete video extraction pipeline: Instagram URL -> Cobalt download -> native audio extraction -> thumbnail capture -> Whisper transcription -> Claude structuring -> saved recipe with real data and thumbnail.
  </what-built>
  <how-to-verify>
**Pre-requisites (run both servers):**
1. Start Cobalt: `./scripts/cobalt-server.sh`
   - Verify: `curl -s http://127.0.0.1:9000/` should return a response (not connection refused)
2. Start Whisper: `./scripts/whisper-server.sh`
   - Verify: Server logs show "listening on 127.0.0.1:8080"

**Build and run the app:**
3. Build: `npx expo run:ios --simulator`
4. App should launch in iOS Simulator

**Test with a real Instagram URL:**
5. Find a public Instagram cooking reel URL (e.g., a short recipe video)
6. Paste the URL into the app's input field
7. Tap process/submit

**Verify each stage:**
8. "Downloading video..." appears (Cobalt resolves URL, video downloads)
9. Progress advances to "Transcribing audio..." (audio was extracted)
10. Progress advances to "Creating recipe..." (transcription completed)
11. Processing completes -- recipe is saved

**Verify the result:**
12. Recipe has a REAL title (not "Creamy Garlic Tuscan Shrimp" -- that was mock data)
13. Recipe has real ingredients and steps from the video
14. Recipe has a thumbnail image displayed (not blank/placeholder)
15. Recipe has the source URL saved

**Verify cleanup:**
16. No video files lingering in the simulator's cache:
    ```bash
    find ~/Library/Developer/CoreSimulator -path "*/wechef-videos/*" -type f 2>/dev/null
    ```
    Should return nothing (video was deleted after extraction).

**Error handling test:**
17. Try an invalid URL (e.g., "https://google.com") -- should show error message
18. Try with Cobalt stopped -- should show descriptive error about Cobalt not running
  </how-to-verify>
  <resume-signal>Type "approved" if end-to-end extraction works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Pipeline store imports real extraction, not mocks
2. No TypeScript errors: `npx tsc --noEmit`
3. App builds: `npx expo run:ios --simulator`
4. End-to-end test passes with real Instagram URL
5. Recipe contains real data (not mock), with thumbnail
6. No video files left in cache after processing
7. Error messages are descriptive for common failure modes
</verification>

<success_criteria>
- lib/pipeline/store.ts uses extractFromInstagramUrl (no more mockDownload/mockExtract)
- Real Instagram URL produces real recipe with real thumbnail
- Video file deleted after extraction (verified by filesystem check)
- Audio file deleted after transcription
- Invalid URLs and server-down scenarios produce clear error messages
- Human verified end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-extraction/04-02-SUMMARY.md`
</output>
