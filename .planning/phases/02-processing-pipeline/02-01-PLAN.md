---
phase: 02-processing-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/pipeline/types.ts
  - lib/pipeline/store.ts
  - lib/pipeline/mock-api.ts
  - components/URLInput.tsx
  - components/ProgressIndicator.tsx
autonomous: true

must_haves:
  truths:
    - "Pipeline store tracks current processing stage"
    - "Mock APIs simulate processing delays"
    - "URL input accepts Instagram URLs"
    - "Progress indicator animates smoothly between stages"
  artifacts:
    - path: "lib/pipeline/types.ts"
      provides: "Pipeline stage types and labels"
      contains: "PipelineStage"
    - path: "lib/pipeline/store.ts"
      provides: "Zustand store for pipeline state"
      exports: ["usePipelineStore"]
    - path: "lib/pipeline/mock-api.ts"
      provides: "Mock API functions with delays"
      exports: ["mockDownload", "mockExtract", "mockTranscribe", "mockStructure"]
    - path: "components/URLInput.tsx"
      provides: "Text input for Instagram URL"
      exports: ["URLInput"]
    - path: "components/ProgressIndicator.tsx"
      provides: "Animated progress bar"
      exports: ["ProgressIndicator"]
  key_links:
    - from: "lib/pipeline/store.ts"
      to: "lib/pipeline/mock-api.ts"
      via: "import and call mock functions"
      pattern: "import.*mock-api"
    - from: "lib/pipeline/store.ts"
      to: "lib/pipeline/types.ts"
      via: "type imports"
      pattern: "import.*PipelineStage.*types"
    - from: "components/ProgressIndicator.tsx"
      to: "react-native-reanimated"
      via: "animation hooks"
      pattern: "useSharedValue|useAnimatedStyle"
---

<objective>
Create the processing pipeline foundation with Zustand state management, mock API functions, and reusable UI components for URL input and progress display.

Purpose: Establishes the core pipeline architecture that will be used to orchestrate recipe extraction. Mock APIs simulate the full processing flow (download, extract, transcribe, structure) with realistic delays.

Output: Pipeline store with state management, mock APIs, URL input component, and animated progress indicator ready for integration.
</objective>

<execution_context>
@/Users/damienanselmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damienanselmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-processing-pipeline/02-RESEARCH.md

# Existing code to reference
@lib/types.ts
@lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zustand and Create Pipeline Foundation</name>
  <files>
    lib/pipeline/types.ts
    lib/pipeline/store.ts
    lib/pipeline/mock-api.ts
  </files>
  <action>
1. Install Zustand:
   ```bash
   npm install zustand --legacy-peer-deps
   ```

2. Create `lib/pipeline/types.ts`:
   - Define `PipelineStage` type: 'idle' | 'downloading' | 'extracting' | 'transcribing' | 'structuring' | 'complete' | 'error'
   - Define `PipelineState` interface with: stage, progress (0-1), error (string | null), sourceUrl (string | null)
   - Export `STAGE_LABELS` record mapping stage to user-friendly text (e.g., 'downloading' -> 'Downloading video...')
   - Export `STAGE_PROGRESS` record mapping stage to overall progress (idle=0, downloading=0.25, extracting=0.5, transcribing=0.75, structuring=0.9, complete=1, error=0)

3. Create `lib/pipeline/mock-api.ts`:
   - Create `delay` helper: `const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));`
   - Create `mockDownload(url: string)`: 2000ms delay, returns void (simulates video download)
   - Create `mockExtract()`: 1500ms delay, returns 'extracted_audio' string
   - Create `mockTranscribe()`: 2000ms delay, returns mock transcript text
   - Create `mockStructure(transcript: string)`: 1500ms delay, returns `NewRecipe` with hardcoded mock recipe data
   - Import `NewRecipe` type from `@/lib/types`

4. Create `lib/pipeline/store.ts`:
   - Import `create` from 'zustand'
   - Import types from './types' and mock functions from './mock-api'
   - Import `NewRecipe` from '@/lib/types'
   - Define `PipelineStore` interface extending `PipelineState` with:
     - `startProcessing(url: string): Promise<NewRecipe | null>` - runs full pipeline
     - `reset(): void` - clears state to idle
   - Implement store with `create<PipelineStore>`:
     - Initial state: stage='idle', progress=0, error=null, sourceUrl=null
     - `startProcessing`: Clear error, set sourceUrl, progress through stages calling mock APIs, return recipe on success, set error on failure
     - `reset`: Return to initial state
  </action>
  <verify>
    - `npm list zustand` shows zustand installed
    - `npx tsc --noEmit` passes (no TypeScript errors)
    - Files exist: `lib/pipeline/types.ts`, `lib/pipeline/store.ts`, `lib/pipeline/mock-api.ts`
  </verify>
  <done>
    - Zustand installed
    - Pipeline types define all stages and labels
    - Mock APIs simulate 7 seconds total processing time
    - Pipeline store orchestrates stage transitions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create URL Input and Progress Indicator Components</name>
  <files>
    components/URLInput.tsx
    components/ProgressIndicator.tsx
  </files>
  <action>
1. Create `components/URLInput.tsx`:
   - Accept props: `onSubmit: (url: string) => void`, `disabled?: boolean`
   - Use local state for input value
   - Render View container with:
     - TextInput with placeholder "Paste Instagram URL..."
     - Style: border, rounded corners, padding, full width
     - Set `autoCapitalize="none"`, `autoCorrect={false}`, `keyboardType="url"`
     - Set `editable={!disabled}`
   - Render submit Pressable button:
     - Text "Process"
     - Disabled state when input empty or disabled prop true
     - onPress: call onSubmit with URL, clear input
   - Use NativeWind classes for styling (follow existing component patterns)

2. Create `components/ProgressIndicator.tsx`:
   - Accept props: `progress: number` (0-1), `stage: string`
   - Use `useSharedValue` from react-native-reanimated for animated width
   - Use `useEffect` to animate width.value with `withTiming` when progress changes (duration: 300ms)
   - Use `useAnimatedStyle` to create width percentage style
   - Render:
     - Outer View: full width, h-2, bg-gray-200, rounded-full, overflow-hidden
     - Inner Animated.View: h-full, bg-blue-500, rounded-full, with animated width style
     - Text below showing stage label
   - Import Animated from 'react-native-reanimated' (NOT from 'react-native')
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Files exist: `components/URLInput.tsx`, `components/ProgressIndicator.tsx`
  </verify>
  <done>
    - URLInput component accepts URL and triggers onSubmit callback
    - ProgressIndicator animates smoothly using reanimated shared values
    - Both components use NativeWind styling consistent with existing components
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. `npm list zustand` confirms installation
2. `npx tsc --noEmit` passes with no errors
3. All 5 files created in correct locations
4. TypeScript imports resolve correctly between pipeline files
</verification>

<success_criteria>
- Zustand installed and pipeline store functional
- Mock APIs return mock recipe after ~7 seconds total delay
- URL input component ready for integration
- Progress indicator animates with reanimated
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-processing-pipeline/02-01-SUMMARY.md`
</output>
