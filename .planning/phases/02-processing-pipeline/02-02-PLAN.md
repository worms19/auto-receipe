---
phase: 02-processing-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - components/ProcessingModal.tsx
  - app/(tabs)/index.tsx
autonomous: false

must_haves:
  truths:
    - "User can enter Instagram URL and trigger processing"
    - "User sees modal with real-time progress during processing"
    - "User is notified when processing completes or fails"
    - "Processed recipe is saved to collection automatically"
  artifacts:
    - path: "components/ProcessingModal.tsx"
      provides: "Modal showing pipeline progress"
      exports: ["ProcessingModal"]
    - path: "app/(tabs)/index.tsx"
      provides: "Home screen with URL input and processing trigger"
      contains: "URLInput"
  key_links:
    - from: "components/ProcessingModal.tsx"
      to: "lib/pipeline/store.ts"
      via: "usePipelineStore hook"
      pattern: "usePipelineStore"
    - from: "app/(tabs)/index.tsx"
      to: "lib/pipeline/store.ts"
      via: "usePipelineStore hook"
      pattern: "usePipelineStore"
    - from: "app/(tabs)/index.tsx"
      to: "lib/db.ts"
      via: "saveRecipe function"
      pattern: "saveRecipe"
---

<objective>
Integrate the processing pipeline with the home screen UI, creating a modal that displays processing progress and automatically saves completed recipes to the collection.

Purpose: Completes the Phase 2 user flow - user enters URL, sees progress, and gets recipe saved to their collection.

Output: Working processing flow from URL input through progress display to saved recipe.
</objective>

<execution_context>
@/Users/damienanselmi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/damienanselmi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-processing-pipeline/02-RESEARCH.md
@.planning/phases/02-processing-pipeline/02-01-SUMMARY.md

# Files from Plan 01
@lib/pipeline/types.ts
@lib/pipeline/store.ts
@components/URLInput.tsx
@components/ProgressIndicator.tsx

# Existing files to modify/reference
@app/(tabs)/index.tsx
@lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Processing Modal Component</name>
  <files>
    components/ProcessingModal.tsx
  </files>
  <action>
1. Create `components/ProcessingModal.tsx`:
   - Accept props: `visible: boolean`, `onClose: () => void`, `onRecipeSaved?: () => void`
   - Import `usePipelineStore` from '@/lib/pipeline/store'
   - Import `STAGE_LABELS, STAGE_PROGRESS` from '@/lib/pipeline/types'
   - Import `ProgressIndicator` from './ProgressIndicator'
   - Get state from store: `const { stage, error, reset } = usePipelineStore()`
   - Compute: `progress = STAGE_PROGRESS[stage]`, `label = STAGE_LABELS[stage]`
   - Derive: `isComplete = stage === 'complete'`, `isError = stage === 'error'`, `isProcessing = !['idle', 'complete', 'error'].includes(stage)`

2. Render Modal structure:
   - Use React Native `Modal` with `visible={visible}`, `transparent`, `animationType="fade"`
   - Outer View: flex-1, justify-center, items-center, bg-black/50 (semi-transparent backdrop)
   - Inner View: bg-white, rounded-2xl, p-6, mx-6, w-80

3. Modal content:
   - Text header showing `label` (stage label) - text-lg, font-semibold, text-center, mb-4
   - ProgressIndicator component with progress and stage props
   - If `isError`: Show error text in red below progress bar (mt-4)
   - If `isComplete` or `isError`: Show action button
     - Complete: "View Recipes" button - bg-green-500, calls onClose then onRecipeSaved
     - Error: "Try Again" button - bg-red-500, calls reset() then onClose
   - Button style: mt-6, rounded-lg, py-3, text-white, text-center, font-semibold

4. Handle modal dismiss:
   - Only allow closing when complete or error (not during processing)
   - On complete close: call onRecipeSaved callback if provided
   - On error close: reset pipeline state
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exists: `components/ProcessingModal.tsx`
  </verify>
  <done>
    - ProcessingModal shows current processing stage with label
    - Progress bar animates through stages
    - Error state displays error message with retry option
    - Complete state shows success with view recipes button
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Pipeline with Home Screen</name>
  <files>
    app/(tabs)/index.tsx
  </files>
  <action>
1. Add imports to `app/(tabs)/index.tsx`:
   - Import `URLInput` from '@/components/URLInput'
   - Import `ProcessingModal` from '@/components/ProcessingModal'
   - Import `usePipelineStore` from '@/lib/pipeline/store'
   - Import `saveRecipe` from '@/lib/db'
   - Import `View` from 'react-native'

2. Add pipeline state and local state:
   - Get from store: `const { stage, startProcessing, reset } = usePipelineStore()`
   - Add state: `const [modalVisible, setModalVisible] = useState(false)`
   - Derive: `const isProcessing = !['idle', 'complete', 'error'].includes(stage)`

3. Create `handleProcess` async function:
   - Set modalVisible to true
   - Call `const recipe = await startProcessing(url)`
   - If recipe is not null:
     - Call `await saveRecipe(db, recipe)` to persist to SQLite
   - (Modal handles the rest of the flow)

4. Create `handleModalClose` function:
   - Set modalVisible to false
   - Call reset() to clear pipeline state

5. Create `handleRecipeSaved` function:
   - Call loadRecipes() to refresh the list

6. Update the component render:
   - Wrap existing content in a parent View with flex-1
   - Add URLInput component at TOP of the screen (before FlatList/EmptyState)
     - Pass `onSubmit={handleProcess}`
     - Pass `disabled={isProcessing}`
   - Add ProcessingModal component
     - Pass `visible={modalVisible}`
     - Pass `onClose={handleModalClose}`
     - Pass `onRecipeSaved={handleRecipeSaved}`
   - Keep existing FlatList/EmptyState logic below URLInput

7. Style the layout:
   - URLInput container: p-4, bg-white, border-b, border-gray-200
   - Main content area: flex-1
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx expo start` - app runs without errors
    - Visual check: URL input visible at top of home screen
  </verify>
  <done>
    - URL input appears at top of recipe list screen
    - Entering URL and pressing Process opens modal
    - Modal shows progress through all stages
    - Recipe saves to database on completion
    - Recipe list refreshes to show new recipe
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete processing pipeline flow with URL input, progress modal, and recipe saving</what-built>
  <how-to-verify>
1. Start the app: `npx expo start` and open on device/simulator
2. On the home screen, you should see:
   - URL input field at the top with "Paste Instagram URL..." placeholder
   - "Process" button next to it
   - Recipe list below (with any existing mock recipes)

3. Test the processing flow:
   - Paste any URL (e.g., "https://instagram.com/p/test123")
   - Tap "Process" button
   - Modal should appear with "Downloading video..." message
   - Watch progress bar animate through stages:
     - Downloading video... (~2 sec)
     - Extracting content... (~1.5 sec)
     - Transcribing audio... (~2 sec)
     - Creating recipe... (~1.5 sec)
     - Done!
   - Total time: ~7 seconds

4. Verify completion:
   - Modal shows "Done!" with green "View Recipes" button
   - Tap "View Recipes"
   - Modal closes
   - New recipe appears in list (mock recipe with hardcoded data)

5. Test error handling (optional):
   - If you want to test error state, temporarily modify mock-api.ts to throw an error
   - Should show error message with "Try Again" button

6. Verify persistence:
   - Close and reopen the app
   - New recipe should still be in the list
  </how-to-verify>
  <resume-signal>Type "approved" if flow works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 2 Success Criteria verification:
1. User can enter an Instagram URL manually and trigger processing - YES (URLInput + Process button)
2. User sees real-time progress indicator during processing - YES (ProcessingModal with ProgressIndicator)
3. User is notified when processing completes or fails - YES (Modal shows Done! or error message)
4. Mock recipe is saved to collection after processing completes - YES (saveRecipe called, list refreshes)
</verification>

<success_criteria>
- URL input accepts text and triggers processing
- Modal displays and animates through all 4 stages
- Progress bar smoothly animates between stages
- Completion shows success state with action button
- Error state shows message and retry option
- Recipe persists to SQLite database
- Recipe list refreshes to show new recipe
- Human verification confirms full flow works
</success_criteria>

<output>
After completion, create `.planning/phases/02-processing-pipeline/02-02-SUMMARY.md`
</output>
